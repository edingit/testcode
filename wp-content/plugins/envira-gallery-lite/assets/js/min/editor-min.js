if("undefined"==typeof EnviraGalleryModalWindow)var EnviraGalleryModalWindow=new wp.media.view.Modal({controller:{trigger:function(){}}});wp.media.view.EnviraGalleryError=wp.Backbone.View.extend({tagName:"div",className:"notice error envira-gallery-error",render:function(){return this.template=wp.media.template("envira-gallery-error"),this.$el.html(this.template(this.model)),this}});var EnviraGallerySelectionItemView=wp.Backbone.View.extend({tagName:"li",className:"attachment",template:wp.template("envira-selection-item"),initialize:function(e){this.model=e.model},render:function(){return this.$el.html(this.template(this.model.attributes)),this}}),EnviraGallerySelectionView=wp.Backbone.View.extend({tagName:"div",className:"media-frame mode-select wp-core-ui hide-router hide-menu",template:wp.template("envira-selection"),events:{"click .attachment":"click",keyup:"search",search:"search","click button.media-button-insert":"insert"},initialize:function(e){this.action=e.action,this.selection=new Backbone.Collection,this.collection=new Backbone.Collection,this.is_loading=!1,this.search_timeout=!1,this.on("loading",this.loading,this),this.on("loaded",this.loaded,this),this.getItems(!1,"")},click:function(e){var i=jQuery(e.currentTarget),t=jQuery("div.attachment-preview",i).attr("data-id");i.hasClass("selected")?this.removeFromSelection(i,t):this.addToSelection(i,t)},search:function(e){if(!this.is_loading){clearTimeout(this.search_timeout);var i=e.target.value;if(0==i.length)return void this.getItems(!1,"");if(!(i.length<3)){var t=this;this.search_timeout=setTimeout(function(){t.getItems(!0,i)},1e3)}}},getItems:function(e,i){if(!this.is_loading){this.clearSelection(),this.$el.find("ul.attachments").empty(),this.$el.find("div.envira-gallery-error").remove(),this.trigger("loading");var t="";switch(this.action){case"gallery":t="envira_gallery_editor_get_galleries";break;case"album":t="envira_albums_editor_get_albums"}wp.media.ajax(t,{context:this,data:{nonce:envira_gallery_editor.get_galleries_nonce,search:e,search_terms:i},success:function(e){var i=new Backbone.Collection(e);this.collection.reset(),this.collection.add(i.models),this.collection.each(function(e){var i=new EnviraGallerySelectionItemView({model:e});this.$el.find("ul.attachments").append(i.render().el)},this),this.trigger("loaded")},error:function(e){this.trigger("loaded",e)}})}},render:function(){return this.$el.html(this.template()),this},renderError:function(e){var i={};i.error=e;var t=new wp.media.view.EnviraGalleryError({model:i});return t.render().el},loading:function(){this.is_loading=!0,this.$el.find(".spinner").css("visibility","visible")},loaded:function(e){this.is_loading=!1,this.$el.find(".spinner").css("visibility","hidden"),"undefined"!=typeof e&&this.$el.find("ul.attachments").before(this.renderError(e))},addToSelection:function(e,i){this.trigger("loading"),this.collection.each(function(e){e.get("id")==i&&this.selection.add(e)},this),e.addClass("selected details"),this.selection.length>0&&this.$el.find("button.media-button-insert").attr("disabled",!1),this.trigger("loaded")},removeFromSelection:function(e,i){this.trigger("loading"),this.selection.each(function(e){this.selection.remove([{cid:e.cid}])},this),e.removeClass("selected details"),0==this.selection.length&&this.$el.find("button.media-button-insert").attr("disabled","disabled"),this.trigger("loaded")},clearSelection:function(){this.selection.each(function(e){this.$el.find('div[data-id="'+e.get("id")+'"]').parent().removeClass("selected details")},this),this.$el.find("button.media-button-insert").attr("disabled","disabled"),this.selection.reset()},insert:function(){this.trigger("loading"),this.selection.forEach(function(e){wp.media.editor.insert("[envira-"+this.action+' id="'+e.id+'"]')},this),this.trigger("loaded"),EnviraGalleryModalWindow.close()}});jQuery(document).ready(function($){$(document).on("click","a.envira-gallery-choose-gallery, a.envira-albums-choose-album",function(e){e.preventDefault();var i=$(this).data("action");EnviraGalleryModalWindow.content(new EnviraGallerySelectionView({action:i})),EnviraGalleryModalWindow.open()})});